<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Falcon's Escape - Star Wars Arena Shooter</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        #gameCanvas {
            display: block;
            background: radial-gradient(circle, #001122 0%, #000000 100%);
            touch-action: none;
        }

        #joystick {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(0, 200, 255, 0.5);
            border-radius: 50%;
            touch-action: none;
            z-index: 10;
        }

        #joystickKnob {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(0, 200, 255, 0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: none;
        }

        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            color: white;
            z-index: 10;
            pointer-events: none;
        }

        #healthBar {
            width: 200px;
            height: 20px;
            background: rgba(255, 0, 0, 0.3);
            border: 2px solid #fff;
            margin-bottom: 10px;
        }

        #healthFill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000, #00ff00);
            transition: width 0.3s ease;
        }

        #pauseBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #0cf;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 10;
        }

        #menu, #gameOverScreen, #levelIntro {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 20;
        }

        .menu-button {
            background: linear-gradient(45deg, #001122, #004488);
            color: white;
            border: 2px solid #0cf;
            padding: 15px 30px;
            margin: 10px;
            cursor: pointer;
            font-size: 18px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .menu-button:hover {
            background: linear-gradient(45deg, #004488, #0066cc);
            box-shadow: 0 0 20px #0cf;
        }

        #videoOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 30;
            display: none;
        }

        #skipBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 2px solid #0cf;
            padding: 10px 20px;
            cursor: pointer;
            z-index: 31;
        }

        .star {
            position: absolute;
            background: white;
            width: 2px;
            height: 2px;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        @keyframes explosion {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(2); opacity: 0; }
        }

        .explosion {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle, #ff6600, #ffff00);
            border-radius: 50%;
            animation: explosion 0.5s ease-out forwards;
            pointer-events: none;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <!-- SVG Sprites -->
    <svg style="display: none;">
        <defs>
            <!-- Millennium Falcon -->
            <g id="falcon">
                <ellipse cx="0" cy="0" rx="25" ry="15" fill="#cccccc" stroke="#888888" stroke-width="2"/>
                <ellipse cx="-10" cy="0" rx="8" ry="12" fill="#aaaaaa"/>
                <ellipse cx="10" cy="0" rx="8" ry="12" fill="#aaaaaa"/>
                <circle cx="-5" cy="-8" r="3" fill="#0088ff"/>
                <circle cx="5" cy="-8" r="3" fill="#0088ff"/>
                <rect x="-2" y="15" width="4" height="8" fill="#ff6600"/>
                <rect x="-8" y="12" width="4" height="6" fill="#ff6600"/>
                <rect x="4" y="12" width="4" height="6" fill="#ff6600"/>
            </g>

            <!-- TIE Fighter -->
            <g id="tie">
                <circle cx="0" cy="0" r="8" fill="#333333" stroke="#666666" stroke-width="1"/>
                <rect x="-15" y="-5" width="30" height="10" fill="#444444"/>
                <rect x="-12" y="-3" width="24" height="6" fill="#666666"/>
                <circle cx="0" cy="0" r="4" fill="#ff0000"/>
            </g>

            <!-- Boss Ship -->
            <g id="boss">
                <ellipse cx="0" cy="0" rx="40" ry="20" fill="#444444" stroke="#666666" stroke-width="3"/>
                <ellipse cx="0" cy="0" rx="30" ry="15" fill="#666666"/>
                <rect x="-35" y="-8" width="70" height="16" fill="#333333"/>
                <circle cx="-20" cy="0" r="6" fill="#ff0000"/>
                <circle cx="0" cy="0" r="6" fill="#ff0000"/>
                <circle cx="20" cy="0" r="6" fill="#ff0000"/>
                <rect x="-5" y="20" width="10" height="15" fill="#ff6600"/>
            </g>

            <!-- Laser Bolt -->
            <g id="laser">
                <rect x="-1" y="-8" width="2" height="16" fill="#00ff00"/>
                <rect x="-2" y="-6" width="4" height="12" fill="#88ff88" opacity="0.5"/>
            </g>

            <!-- Enemy Laser -->
            <g id="enemyLaser">
                <rect x="-1" y="-8" width="2" height="16" fill="#ff0000"/>
                <rect x="-2" y="-6" width="4" height="12" fill="#ff8888" opacity="0.5"/>
            </g>

            <!-- Power-up -->
            <g id="powerup">
                <rect x="-8" y="-8" width="16" height="16" fill="#0088ff" stroke="#00ccff" stroke-width="2"/>
                <rect x="-6" y="-6" width="12" height="12" fill="#00ccff" opacity="0.7"/>
                <text x="0" y="4" text-anchor="middle" fill="white" font-size="12">+</text>
            </g>
        </defs>
    </svg>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="hud">
        <div id="healthBar">
            <div id="healthFill" style="width: 100%;"></div>
        </div>
        <div class="text-white text-lg">
            Punkty: <span id="score">0</span> | Poziom: <span id="level">1</span>
        </div>
    </div>

    <!-- Joystick -->
    <div id="joystick">
        <div id="joystickKnob"></div>
    </div>

    <!-- Pause Button -->
    <button id="pauseBtn" class="menu-button">
        <i class="fas fa-pause"></i>
    </button>

    <!-- Main Menu -->
    <div id="menu">
        <h1 class="text-6xl mb-8 text-blue-400 font-bold">FALCON'S ESCAPE</h1>
        <p class="text-xl mb-8 text-center max-w-md">Steruj Millennium Falconem i uciekaj przed flotą Imperium!</p>
        <button id="startBtn" class="menu-button">
            <i class="fas fa-play mr-2"></i>START GRY
        </button>
        <button id="instructionsBtn" class="menu-button">
            <i class="fas fa-info-circle mr-2"></i>INSTRUKCJE
        </button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="hidden">
        <h2 class="text-4xl mb-4 text-red-400">MISJA ZAKOŃCZONA</h2>
        <p class="text-xl mb-4">Twój wynik: <span id="finalScore">0</span></p>
        <p class="text-xl mb-8">Osiągnięty poziom: <span id="finalLevel">1</span></p>
        <button id="restartBtn" class="menu-button">
            <i class="fas fa-redo mr-2"></i>ZAGRAJ PONOWNIE
        </button>
        <button id="menuBtn" class="menu-button">
            <i class="fas fa-home mr-2"></i>MENU GŁÓWNE
        </button>
    </div>

    <!-- Level Intro -->
    <div id="levelIntro" class="hidden">
        <h2 class="text-4xl mb-4 text-yellow-400">POZIOM <span id="currentLevelText">1</span></h2>
        <p class="text-xl mb-8 text-center max-w-lg" id="levelDescription">Flotilla myśliwców TIE nadciąga! Przygotuj się do walki!</p>
        <button id="startLevelBtn" class="menu-button">
            <i class="fas fa-rocket mr-2"></i>ROZPOCZNIJ POZIOM
        </button>
    </div>

    <!-- Video Overlay -->
    <div id="videoOverlay">
        <button id="skipBtn">
            <i class="fas fa-forward mr-2"></i>POMIŃ
        </button>
        <video id="cutsceneVideo" controls playsinline webkit-playsinline style="width: 100%; height: 100%; object-fit: cover;">
            <!-- Placeholder for cutscene videos -->
            <source src="placeholder_cutscene_level1.mp4" type="video/mp4">
            <p>Twoja przeglądarka nie obsługuje video HTML5.</p>
        </video>
    </div>

    <script>
        // Game variables
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Responsive canvas setup
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Game state
        const game = {
            state: 'menu', // menu, playing, paused, gameOver, levelIntro
            level: 1,
            score: 0,
            player: {
                worldX: 0,  // Player's position in world coordinates
                worldY: 0,
                health: 100,
                maxHealth: 100,
                angle: 0,
                speed: 0,
                maxSpeed: 5
            },
            camera: { x: 0, y: 0 },
            enemies: [],
            lasers: [],
            powerups: [],
            explosions: [],
            lastShot: 0,
            shootCooldown: 200,
            enemySpawnTimer: 0,
            enemiesKilled: 0,
            enemiesNeededForNextLevel: 10,
            joystick: {
                active: false,
                x: 0,
                y: 0,
                centerX: 80,
                centerY: window.innerHeight - 80,
                radius: 60
            },
            bossActive: false,
            boss: null
        };

        // Level configurations
        const levelConfigs = [
            { 
                name: "TIE Fighter Assault", 
                description: "Flotilla myśliwców TIE nadciąga! Przygotuj się do walki!",
                enemyTypes: ['tie'],
                spawnRate: 2000,
                maxEnemies: 10,
                bossType: 'tie-boss'
            },
            { 
                name: "Imperial Squadron", 
                description: "Elitarne eskadry Imperium! Uważaj na ich formacje!",
                enemyTypes: ['tie', 'heavy'],
                spawnRate: 1500,
                maxEnemies: 10,
                bossType: 'destroyer'
            },
            { 
                name: "Death Star Approach", 
                description: "Zbliżasz się do Gwiazdy Śmierci. To będzie trudne!",
                enemyTypes: ['tie', 'heavy', 'interceptor'],
                spawnRate: 1000,
                maxEnemies: 30,
                bossType: 'death-star'
            }
        ];

        // Input handling
        let keys = {};
        
        // Touch/Mouse joystick
        const joystickElement = document.getElementById('joystick');
        const knobElement = document.getElementById('joystickKnob');

        function handleJoystickStart(e) {
            game.joystick.active = true;
            updateJoystick(e);
        }

        function handleJoystickMove(e) {
            if (game.joystick.active) {
                updateJoystick(e);
            }
        }

        function handleJoystickEnd() {
            game.joystick.active = false;
            game.joystick.x = 0;
            game.joystick.y = 0;
            knobElement.style.transform = 'translate(-50%, -50%)';
        }

        function updateJoystick(e) {
            const rect = joystickElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            let clientX, clientY;
            if (e.touches && e.touches[0]) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const deltaX = clientX - centerX;
            const deltaY = clientY - centerY;
            const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
            const maxDistance = game.joystick.radius / 2;
            
            if (distance <= maxDistance) {
                game.joystick.x = deltaX / maxDistance * 0.8;
                game.joystick.y = deltaY / maxDistance * 0.8;
                knobElement.style.transform = `translate(${deltaX - 25}px, ${deltaY - 25}px)`;
            } else {
                const angle = Math.atan2(deltaY, deltaX);
                game.joystick.x = Math.cos(angle);
                game.joystick.y = Math.sin(angle);
                knobElement.style.transform = `translate(${Math.cos(angle) * maxDistance - 25}px, ${Math.sin(angle) * maxDistance - 25}px)`;
            }
        }

        // Event listeners for joystick
        joystickElement.addEventListener('touchstart', handleJoystickStart);
        joystickElement.addEventListener('touchmove', handleJoystickMove);
        joystickElement.addEventListener('touchend', handleJoystickEnd);
        joystickElement.addEventListener('mousedown', handleJoystickStart);
        document.addEventListener('mousemove', handleJoystickMove);
        document.addEventListener('mouseup', handleJoystickEnd);

        // Menu event listeners
        document.getElementById('startBtn').addEventListener('click', startGame);
        document.getElementById('restartBtn').addEventListener('click', restartGame);
        document.getElementById('menuBtn').addEventListener('click', showMenu);
        document.getElementById('pauseBtn').addEventListener('click', togglePause);
        document.getElementById('startLevelBtn').addEventListener('click', startLevel);
        document.getElementById('skipBtn').addEventListener('click', skipCutscene);

        // Game functions
        function startGame() {
            game.state = 'levelIntro';
            game.level = 1;
            game.score = 0;
            resetPlayer();
            showLevelIntro();
        }

        function restartGame() {
            game.state = 'levelIntro';
            game.level = 1;
            game.score = 0;
            game.enemies = [];
            game.lasers = [];
            game.powerups = [];
            game.explosions = [];
            game.enemiesKilled = 0;
            game.bossActive = false;
            game.boss = null;
            resetPlayer();
            showLevelIntro();
        }

        function showMenu() {
            game.state = 'menu';
            document.getElementById('menu').classList.remove('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            document.getElementById('levelIntro').classList.add('hidden');
        }

        function showLevelIntro() {
            const config = levelConfigs[(game.level - 1) % levelConfigs.length];
            document.getElementById('currentLevelText').textContent = game.level;
            document.getElementById('levelDescription').textContent = config.description;
            document.getElementById('levelIntro').classList.remove('hidden');
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
        }

        function startLevel() {
            game.state = 'playing';
            document.getElementById('levelIntro').classList.add('hidden');
            
            // Reset level-specific variables
            game.enemies = [];
            game.lasers = [];
            game.powerups = [];
            game.explosions = [];
            game.enemiesKilled = 0;
            game.enemiesNeededForNextLevel = 10 + (game.level - 1) * 5;
            game.bossActive = false;
            game.boss = null;
            
            // Show cutscene placeholder (in real game, load specific video for level)
            showCutscene();
        }

        function showCutscene() {
            const videoOverlay = document.getElementById('videoOverlay');
            const video = document.getElementById('cutsceneVideo');
            
            // In a real implementation, you would load different videos per level
            // video.src = `cutscene_level_${game.level}.mp4`;
            
            videoOverlay.style.display = 'block';
            
            // Auto-skip after 3 seconds for demo (in real game, play full video)
            setTimeout(() => {
                skipCutscene();
            }, 3000);
        }

        function skipCutscene() {
            document.getElementById('videoOverlay').style.display = 'none';
            // Start actual gameplay
            gameLoop();
        }

        function togglePause() {
            if (game.state === 'playing') {
                game.state = 'paused';
            } else if (game.state === 'paused') {
                game.state = 'playing';
                gameLoop();
            }
        }

        function resetPlayer() {
            game.player.worldX = 0;
            game.player.worldY = 0;
            game.player.health = game.player.maxHealth;
            game.player.angle = 0;
            game.camera.x = 0;
            game.camera.y = 0;
        }

        function gameOver() {
            game.state = 'gameOver';
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('finalLevel').textContent = game.level;
            document.getElementById('gameOverScreen').classList.remove('hidden');
        }

        // Game logic
        function updatePlayer() {
            // Aktualizuj pozycje gracza w przestrzeni swiata na podstawie joysticka
            if (game.joystick.active || game.joystick.x !== 0 || game.joystick.y !== 0) {
                game.player.worldX += game.joystick.x * game.player.maxSpeed;
                game.player.worldY += game.joystick.y * game.player.maxSpeed;
            }
            
            // Kamera zawsze sledzi pozycje gracza w przestrzeni swiata
            game.camera.x = game.player.worldX - canvas.width / 2;
            game.camera.y = game.player.worldY - canvas.height / 2;
            
            // Auto-namierzaj na najblizszego wroga
            let nearestEnemy = null;
            let nearestDistance = Infinity;
            
            [...game.enemies, game.boss].filter(e => e).forEach(enemy => {
                const dx = enemy.x - game.player.worldX;
                const dy = enemy.y - game.player.worldY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestEnemy = enemy;
                }
            });
            
            if (nearestEnemy) {
                const dx = nearestEnemy.x - game.player.worldX;
                const dy = nearestEnemy.y - game.player.worldY;
                game.player.angle = Math.atan2(dy, dx);
                
                // Auto-strzelaj
                const now = Date.now();
                if (now - game.lastShot > game.shootCooldown * 2) {
                    fireLaser();
                    game.lastShot = now;
                }
            }
        }

        function fireLaser() {
            // Dodaj pocisk lasera do gry
            game.lasers.push({
                x: game.player.worldX, // Pozycja początkowa lasera (pozycja gracza)
                y: game.player.worldY,
                dx: Math.cos(game.player.angle) * 1, // Prędkość pocisku w osi X
                dy: Math.sin(game.player.angle) * 1, // Prędkość pocisku w osi Y
                type: 'player' // Typ pocisku (gracza)
            });
        }

        function spawnEnemy() {
            const config = levelConfigs[(game.level - 1) % levelConfigs.length];
            if (game.enemies.length >= config.maxEnemies) return;
            
            // Spawn around player but off-screen
            const angle = Math.random() * Math.PI * 2;
            const distance = 400;
            
            const enemy = {
                x: game.player.worldX + Math.cos(angle) * distance,
                y: game.player.worldY + Math.sin(angle) * distance,
                health: 20,
                maxHealth: 20,
                angle: 0,
                speed: 1 + Math.random(),
                type: config.enemyTypes[Math.floor(Math.random() * config.enemyTypes.length)],
                lastShot: 0,
                shootCooldown: 500 + Math.random() * 1000
            };
            
            game.enemies.push(enemy);
        }

        function spawnBoss() {
            if (game.bossActive) return;
            
            game.bossActive = true;
            const config = levelConfigs[(game.level - 1) % levelConfigs.length];
            
            game.boss = {
                x: game.player.worldX + 400,
                y: game.player.worldY,
                health: 100,
                maxHealth: 100,
                angle: 0,
                speed: 0.5,
                type: config.bossType,
                lastShot: 0,
                shootCooldown: 500,
                phase: 1
            };
        }

        function updateEnemies() {
            // Update regular enemies
            game.enemies.forEach((enemy, index) => {
                // AI: Move towards player
                const dx = game.player.worldX - enemy.x;
                const dy = game.player.worldY - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 50) {
                    enemy.x += (dx / distance) * enemy.speed;
                    enemy.y += (dy / distance) * enemy.speed;
                }
                
                enemy.angle = Math.atan2(dy, dx);
                
                // Enemy shooting
                const now = Date.now();
                if (now - enemy.lastShot > enemy.shootCooldown && distance < 300) {
                    game.lasers.push({
                        x: enemy.x,
                        y: enemy.y,
                        dx: Math.cos(enemy.angle) * 5,
                        dy: Math.sin(enemy.angle) * 5,
                        type: 'enemy'
                    });
                    enemy.lastShot = now;
                }
                
                // Remove dead enemies
                if (enemy.health <= 0) {
                    createExplosion(enemy.x, enemy.y);
                    game.enemies.splice(index, 1);
                    game.score += 100;
                    game.enemiesKilled++;
                    
                    // Chance to spawn power-up
                    if (Math.random() < 0.3) {
                        spawnPowerUp(enemy.x, enemy.y);
                    }
                }
            });
            
            // Update boss
            if (game.boss) {
                const dx = game.player.worldX - game.boss.x;
                const dy = game.player.worldY - game.boss.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Boss AI - circle around player
                game.boss.angle += 0.02;
                game.boss.x += Math.cos(game.boss.angle) * game.boss.speed;
                game.boss.y += Math.sin(game.boss.angle) * game.boss.speed;
                
                // Boss shooting
                const now = Date.now();
                if (now - game.boss.lastShot > game.boss.shootCooldown) {
                    // Multi-directional shots
                    for (let i = 0; i < 3; i++) {
                        const angle = Math.atan2(dy, dx) + (i - 1) * 0.3;
                        game.lasers.push({
                            x: game.boss.x,
                            y: game.boss.y,
                            dx: Math.cos(angle) * 6,
                            dy: Math.sin(angle) * 6,
                            type: 'enemy'
                        });
                    }
                    game.boss.lastShot = now;
                }
                
                // Boss defeated
                if (game.boss.health <= 0) {
                    createExplosion(game.boss.x, game.boss.y, true);
                    game.score += 1000;
                    game.boss = null;
                    game.bossActive = false;
                    
                    // Level complete
                    setTimeout(() => {
                        game.level++;
                        game.state = 'levelIntro';
                        showLevelIntro();
                    }, 2000);
                }
            }
        }

        function updateLasers() {
            game.lasers.forEach((laser, index) => {
                laser.x += laser.dx;
                laser.y += laser.dy;
                
                // Remove off-screen lasers (relative to player position)
                const relativeX = laser.x - game.player.worldX;
                const relativeY = laser.y - game.player.worldY;
                
                if (Math.abs(relativeX) > 800 || Math.abs(relativeY) > 600) {
                    game.lasers.splice(index, 1);
                    return;
                }
                
                // Collision detection
                if (laser.type === 'player') {
                    // Sprawdź kolizje z wrogami
                    game.enemies.forEach(enemy => {
                        const dx = laser.x - enemy.x;
                        const dy = laser.y - enemy.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 20) {
                            // Zadaj obra enie wrogowi
                            enemy.health -= 5;
                            // Usu  laser
                            game.lasers.splice(index, 1);
                        }
                    });
                    
                    // Check collision with boss
                    if (game.boss) {
                        const dx = laser.x - game.boss.x;
                        const dy = laser.y - game.boss.y;
                        if (Math.sqrt(dx * dx + dy * dy) < 40) {
                            game.boss.health -= 10;
                            game.lasers.splice(index, 1);
                        }
                    }
                } else if (laser.type === 'enemy') {
                    // Check collision with player
                    const dx = laser.x - game.player.worldX;
                    const dy = laser.y - game.player.worldY;
                    if (Math.sqrt(dx * dx + dy * dy) < 25) {
                        game.player.health -= 10;
                        game.lasers.splice(index, 1);
                        
                        if (game.player.health <= 0) {
                            gameOver();
                        }
                    }
                }
            });
        }

        function spawnPowerUp(x, y) {
            game.powerups.push({
                x: x,
                y: y,
                type: 'health',
                bobOffset: Math.random() * Math.PI * 2
            });
        }

        function updatePowerUps() {
            game.powerups.forEach((powerup, index) => {
                // Bobbing animation
                powerup.bobOffset += 0.1;
                
                // Check collision with player
                const dx = powerup.x - game.player.worldX;
                const dy = powerup.y - game.player.worldY;
                
                if (Math.sqrt(dx * dx + dy * dy) < 30) {
                    if (powerup.type === 'health') {
                        game.player.health = Math.min(game.player.maxHealth, game.player.health + 25);
                    }
                    game.powerups.splice(index, 1);
                    game.score += 50;
                }
            });
        }

        function createExplosion(x, y, large = false) {
            for (let i = 0; i < (large ? 15 : 8); i++) {
                game.explosions.push({
                    x: x + (Math.random() - 0.5) * (large ? 80 : 40),
                    y: y + (Math.random() - 0.5) * (large ? 80 : 40),
                    life: 30,
                    maxLife: 30,
                    size: large ? Math.random() * 15 + 10 : Math.random() * 8 + 5
                });
            }
        }

        function updateExplosions() {
            game.explosions.forEach((explosion, index) => {
                explosion.life--;
                if (explosion.life <= 0) {
                    game.explosions.splice(index, 1);
                }
            });
        }

        // Rendering
        function render() {
            // Clear canvas with space background
            ctx.fillStyle = '#001122';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw scrolling starfield
            drawStars();
            
            // Save context for world transformations
            ctx.save();
            
            // Apply camera transformation to all world objects
            ctx.translate(-game.camera.x, -game.camera.y);
            
            // Draw power-ups
            game.powerups.forEach(powerup => {
                drawPowerUp(powerup);
            });
            
            // Draw lasers
            game.lasers.forEach(laser => {
                drawLaser(laser);
            });
            
            // Draw enemies
            game.enemies.forEach(enemy => {
                drawEnemy(enemy);
            });
            
            // Draw boss
            if (game.boss) {
                drawBoss(game.boss);
            }
            
            // Draw explosions
            game.explosions.forEach(explosion => {
                drawExplosion(explosion);
            });
            
            ctx.restore();
            
            // Draw player ALWAYS at screen center (no camera transformation)
            drawPlayer();
            
            // Update HUD
            updateHUD();
        }

        function drawStars() {
            // Scrolling star field based on camera position
            ctx.fillStyle = 'white';
            for (let i = 0; i < 100; i++) {
                // Create pseudo-random star positions that move with camera
                const starX = ((i * 73 + game.camera.x * 0.1) % (canvas.width + 100)) - 50;
                const starY = ((i * 91 + game.camera.y * 0.1) % (canvas.height + 100)) - 50;
                const size = (i % 3) + 1;
                ctx.fillRect(starX, starY, size, size);
            }
            
            // Add some distant stars that move slower
            ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
            for (let i = 0; i < 50; i++) {
                const starX = ((i * 127 + game.camera.x * 0.05) % (canvas.width + 200)) - 100;
                const starY = ((i * 163 + game.camera.y * 0.05) % (canvas.height + 200)) - 100;
                ctx.fillRect(starX, starY, 1, 1);
            }
        }

        function drawPlayer() {
            // Player is ALWAYS drawn at screen center
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            
            ctx.save();
            ctx.translate(centerX, centerY);
            ctx.rotate(game.player.angle);
            
            // Draw Millennium Falcon
            ctx.fillStyle = '#cccccc';
            ctx.strokeStyle = '#888888';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.ellipse(0, 0, 25, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            // Cockpit details
            ctx.fillStyle = '#aaaaaa';
            ctx.beginPath();
            ctx.ellipse(-10, 0, 8, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.ellipse(10, 0, 8, 12, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Light details
            ctx.fillStyle = '#0088ff';
            ctx.beginPath();
            ctx.arc(-5, -8, 3, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(5, -8, 3, 0, Math.PI * 2);
            ctx.fill();
            
            // Engine glow
            ctx.fillStyle = '#ff6600';
            ctx.fillRect(-2, 15, 4, 8);
            ctx.fillRect(-8, 12, 4, 6);
            ctx.fillRect(4, 12, 4, 6);
            
            ctx.restore();
        }

        function drawEnemy(enemy) {
            ctx.save();
            ctx.translate(enemy.x, enemy.y);
            ctx.rotate(enemy.angle);
            
            // Draw TIE Fighter
            ctx.fillStyle = '#333333';
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.arc(0, 0, 8, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            ctx.fillStyle = '#444444';
            ctx.fillRect(-15, -5, 30, 10);
            
            ctx.fillStyle = '#666666';
            ctx.fillRect(-12, -3, 24, 6);
            
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(0, 0, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
            
            // Health bar
            if (enemy.health < enemy.maxHealth) {
                drawHealthBar(enemy.x, enemy.y - 25, enemy.health, enemy.maxHealth, 30);
            }
        }

        function drawBoss(boss) {
            ctx.save();
            ctx.translate(boss.x, boss.y);
            ctx.rotate(boss.angle);
            
            // Draw large enemy ship
            ctx.fillStyle = '#444444';
            ctx.strokeStyle = '#666666';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.ellipse(0, 0, 40, 20, 0, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            
            ctx.fillStyle = '#666666';
            ctx.beginPath();
            ctx.ellipse(0, 0, 30, 15, 0, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = '#333333';
            ctx.fillRect(-35, -8, 70, 16);
            
            // Weapon mounts
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(-20, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(0, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            ctx.beginPath();
            ctx.arc(20, 0, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Engine
            ctx.fillStyle = '#ff6600';
            ctx.fillRect(-5, 20, 10, 15);
            
            ctx.restore();
            
            // Boss health bar (larger)
            drawHealthBar(boss.x, boss.y - 50, boss.health, boss.maxHealth, 80);
        }

        function drawLaser(laser) {
            ctx.save();
            ctx.translate(laser.x, laser.y);
            
            if (laser.type === 'player') {
                ctx.fillStyle = '#00ff00';
                ctx.shadowColor = '#00ff00';
                ctx.shadowBlur = 5;
            } else {
                ctx.fillStyle = '#ff0000';
                ctx.shadowColor = '#ff0000';
                ctx.shadowBlur = 5;
            }
            
            ctx.fillRect(-1, -8, 2, 16);
            ctx.shadowBlur = 0;
            ctx.restore();
        }

        function drawPowerUp(powerup) {
            const bobY = powerup.y + Math.sin(powerup.bobOffset) * 5;
            
            ctx.save();
            ctx.translate(powerup.x, bobY);
            
            ctx.fillStyle = '#0088ff';
            ctx.strokeStyle = '#00ccff';
            ctx.lineWidth = 2;
            ctx.fillRect(-8, -8, 16, 16);
            ctx.strokeRect(-8, -8, 16, 16);
            
            ctx.fillStyle = '#00ccff';
            ctx.globalAlpha = 0.7;
            ctx.fillRect(-6, -6, 12, 12);
            ctx.globalAlpha = 1;
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('+', 0, 0);
            
            ctx.restore();
        }

        function drawExplosion(explosion) {
            const alpha = explosion.life / explosion.maxLife;
            
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.fillStyle = `hsl(${30 + Math.random() * 30}, 100%, 60%)`;
            ctx.shadowColor = ctx.fillStyle;
            ctx.shadowBlur = explosion.size;
            ctx.beginPath();
            ctx.arc(explosion.x, explosion.y, explosion.size * alpha, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.restore();
        }

        function drawHealthBar(x, y, health, maxHealth, width) {
            const healthPercent = health / maxHealth;
            
            ctx.fillStyle = 'rgba(255, 0, 0, 0.3)';
            ctx.fillRect(x - width/2, y, width, 6);
            
            ctx.fillStyle = `hsl(${healthPercent * 120}, 100%, 50%)`;
            ctx.fillRect(x - width/2, y, width * healthPercent, 6);
            
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1;
            ctx.strokeRect(x - width/2, y, width, 6);
        }

        function updateHUD() {
            // Update health bar
            const healthPercent = game.player.health / game.player.maxHealth;
            document.getElementById('healthFill').style.width = (healthPercent * 100) + '%';
            
            // Update score and level
            document.getElementById('score').textContent = game.score;
            document.getElementById('level').textContent = game.level;
        }

        // Game loop
        function gameLoop() {
            if (game.state !== 'playing') return;
            
            // Update game logic
            updatePlayer();
            updateEnemies();
            updateLasers();
            updatePowerUps();
            updateExplosions();
            
            // Enemy spawning
            const now = Date.now();
            const config = levelConfigs[(game.level - 1) % levelConfigs.length];
            
            if (now - game.enemySpawnTimer > config.spawnRate) {
                if (!game.bossActive && game.enemiesKilled < game.enemiesNeededForNextLevel) {
                    spawnEnemy();
                }
                game.enemySpawnTimer = now;
            }
            
            // Boss spawning
            if (game.enemiesKilled >= game.enemiesNeededForNextLevel && !game.bossActive && !game.boss) {
                spawnBoss();
            }
            
            // Render
            render();
            
            // Continue loop
            requestAnimationFrame(gameLoop);
        }

        // Initialize
        showMenu();
        
        // Handle window visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && game.state === 'playing') {
                togglePause();
            }
        });
    </script>
</body>
</html>
